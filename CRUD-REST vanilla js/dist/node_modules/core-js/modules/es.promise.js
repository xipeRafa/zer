import global from'../internals/global.js';import isObject from'../internals/is-object.js';import inspectSource from'../internals/inspect-source.js';import IS_PURE from'../internals/is-pure.js';import InternalStateModule from'../internals/internal-state.js';import redefine from'../internals/redefine.js';import getBuiltIn from'../internals/get-built-in.js';import isForced from'../internals/is-forced.js';import $ from'../internals/export.js';import NativePromise from'../internals/native-promise-constructor.js';import redefineAll from'../internals/redefine-all.js';import wellKnownSymbol from'../internals/well-known-symbol.js';import setToStringTag from'../internals/set-to-string-tag.js';import setSpecies from'../internals/set-species.js';import aFunction from'../internals/a-function.js';import anInstance from'../internals/an-instance.js';import iterate from'../internals/iterate.js';import checkCorrectnessOfIteration from'../internals/check-correctness-of-iteration.js';import speciesConstructor from'../internals/species-constructor.js';import IS_NODE from'../internals/engine-is-node.js';import _ref2 from'../internals/task.js';import microtask from'../internals/microtask.js';import newPromiseCapabilityModule from'../internals/new-promise-capability.js';import promiseResolve from'../internals/promise-resolve.js';import hostReportErrors from'../internals/host-report-errors.js';import perform from'../internals/perform.js';import V8_VERSION from'../internals/engine-v8-version.js';(function(module,exports){var Internal,OwnPromiseCapability,PromiseWrapper,nativeThen,task=_ref2.set,SPECIES=wellKnownSymbol("species"),PROMISE="Promise",getInternalState=InternalStateModule.get,setInternalState=InternalStateModule.set,getInternalPromiseState=InternalStateModule.getterFor(PROMISE),PromiseConstructor=NativePromise,TypeError=global.TypeError,document=global.document,process=global.process,$fetch=getBuiltIn("fetch"),newPromiseCapability=newPromiseCapabilityModule.f,newGenericPromiseCapability=newPromiseCapability,DISPATCH_EVENT=!!(document&&document.createEvent&&global.dispatchEvent),NATIVE_REJECTION_EVENT="function"==typeof PromiseRejectionEvent,UNHANDLED_REJECTION="unhandledrejection",REJECTION_HANDLED="rejectionhandled",PENDING=0,FULFILLED=1,REJECTED=2,HANDLED=1,UNHANDLED=2,FORCED=isForced(PROMISE,function(){var GLOBAL_CORE_JS_PROMISE=inspectSource(PromiseConstructor)!==String(PromiseConstructor);if(!GLOBAL_CORE_JS_PROMISE){if(66===V8_VERSION)return !0;if(!IS_NODE&&!NATIVE_REJECTION_EVENT)return !0}if(IS_PURE&&!PromiseConstructor.prototype["finally"])return !0;if(51<=V8_VERSION&&/native code/.test(PromiseConstructor))return !1;var promise=PromiseConstructor.resolve(1),FakePromise=function FakePromise(exec){exec(function(){},function(){});},constructor=promise.constructor={};return constructor[SPECIES]=FakePromise,!(promise.then(function(){})instanceof FakePromise)}),INCORRECT_ITERATION=FORCED||!checkCorrectnessOfIteration(function(iterable){PromiseConstructor.all(iterable)["catch"](function(){});}),isThenable=function isThenable(it){var then;return !!(isObject(it)&&"function"==typeof(then=it.then))&&then},notify=function notify(state,isReject){if(!state.notified){state.notified=!0;var chain=state.reactions;microtask(function(){for(var value=state.value,ok=state.state==FULFILLED,index=0;chain.length>index;){var result,then,exited,reaction=chain[index++],handler=ok?reaction.ok:reaction.fail,resolve=reaction.resolve,reject=reaction.reject,domain=reaction.domain;try{handler?(!ok&&(state.rejection===UNHANDLED&&onHandleUnhandled(state),state.rejection=HANDLED),!0===handler?result=value:(domain&&domain.enter(),result=handler(value),domain&&(domain.exit(),exited=!0)),result===reaction.promise?reject(TypeError("Promise-chain cycle")):(then=isThenable(result))?then.call(result,resolve,reject):resolve(result)):reject(value);}catch(error){domain&&!exited&&domain.exit(),reject(error);}}state.reactions=[],state.notified=!1,isReject&&!state.rejection&&onUnhandled(state);});}},dispatchEvent=function dispatchEvent(name,promise,reason){var event,handler;DISPATCH_EVENT?(event=document.createEvent("Event"),event.promise=promise,event.reason=reason,event.initEvent(name,!1,!0),global.dispatchEvent(event)):event={promise:promise,reason:reason},!NATIVE_REJECTION_EVENT&&(handler=global["on"+name])?handler(event):name===UNHANDLED_REJECTION&&hostReportErrors("Unhandled promise rejection",reason);},onUnhandled=function onUnhandled(state){task.call(global,function(){var result,promise=state.facade,value=state.value,IS_UNHANDLED=isUnhandled(state);if(IS_UNHANDLED&&(result=perform(function(){IS_NODE?process.emit("unhandledRejection",value,promise):dispatchEvent(UNHANDLED_REJECTION,promise,value);}),state.rejection=IS_NODE||isUnhandled(state)?UNHANDLED:HANDLED,result.error))throw result.value});},isUnhandled=function isUnhandled(state){return state.rejection!==HANDLED&&!state.parent},onHandleUnhandled=function onHandleUnhandled(state){task.call(global,function(){var promise=state.facade;IS_NODE?process.emit("rejectionHandled",promise):dispatchEvent(REJECTION_HANDLED,promise,state.value);});},bind=function bind(fn,state,unwrap){return function(value){fn(state,value,unwrap);}},internalReject=function internalReject(state,value,unwrap){state.done||(state.done=!0,unwrap&&(state=unwrap),state.value=value,state.state=REJECTED,notify(state,!0));},internalResolve=function internalResolve(state,value,unwrap){if(!state.done){state.done=!0,unwrap&&(state=unwrap);try{if(state.facade===value)throw TypeError("Promise can't be resolved itself");var then=isThenable(value);then?microtask(function(){var wrapper={done:!1};try{then.call(value,bind(internalResolve,wrapper,state),bind(internalReject,wrapper,state));}catch(error){internalReject(wrapper,error,state);}}):(state.value=value,state.state=FULFILLED,notify(state,!1));}catch(error){internalReject({done:!1},error,state);}}};FORCED&&(PromiseConstructor=function Promise(executor){anInstance(this,PromiseConstructor,PROMISE),aFunction(executor),Internal.call(this);var state=getInternalState(this);try{executor(bind(internalResolve,state),bind(internalReject,state));}catch(error){internalReject(state,error);}},Internal=function Promise(executor){setInternalState(this,{type:PROMISE,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:PENDING,value:void 0});},Internal.prototype=redefineAll(PromiseConstructor.prototype,{then:function then(onFulfilled,onRejected){var state=getInternalPromiseState(this),reaction=newPromiseCapability(speciesConstructor(this,PromiseConstructor));return reaction.ok="function"!=typeof onFulfilled||onFulfilled,reaction.fail="function"==typeof onRejected&&onRejected,reaction.domain=IS_NODE?process.domain:void 0,state.parent=!0,state.reactions.push(reaction),state.state!=PENDING&&notify(state,!1),reaction.promise},catch:function(onRejected){return this.then(void 0,onRejected)}}),OwnPromiseCapability=function(){var promise=new Internal,state=getInternalState(promise);this.promise=promise,this.resolve=bind(internalResolve,state),this.reject=bind(internalReject,state);},newPromiseCapabilityModule.f=newPromiseCapability=function(C){return C===PromiseConstructor||C===PromiseWrapper?new OwnPromiseCapability(C):newGenericPromiseCapability(C)},!IS_PURE&&"function"==typeof NativePromise&&(nativeThen=NativePromise.prototype.then,redefine(NativePromise.prototype,"then",function then(onFulfilled,onRejected){var that=this;return new PromiseConstructor(function(resolve,reject){nativeThen.call(that,resolve,reject);}).then(onFulfilled,onRejected)},{unsafe:!0}),"function"==typeof $fetch&&$({global:!0,enumerable:!0,forced:!0},{fetch:function fetch(input){return promiseResolve(PromiseConstructor,$fetch.apply(global,arguments))}}))),$({global:!0,wrap:!0,forced:FORCED},{Promise:PromiseConstructor}),setToStringTag(PromiseConstructor,PROMISE,!1,!0),setSpecies(PROMISE),PromiseWrapper=getBuiltIn(PROMISE),$({target:PROMISE,stat:!0,forced:FORCED},{reject:function reject(r){var capability=newPromiseCapability(this);return capability.reject.call(void 0,r),capability.promise}}),$({target:PROMISE,stat:!0,forced:IS_PURE||FORCED},{resolve:function resolve(x){return promiseResolve(IS_PURE&&this===PromiseWrapper?PromiseConstructor:this,x)}}),$({target:PROMISE,stat:!0,forced:INCORRECT_ITERATION},{all:function all(iterable){var C=this,capability=newPromiseCapability(C),resolve=capability.resolve,reject=capability.reject,result=perform(function(){var $promiseResolve=aFunction(C.resolve),values=[],counter=0,remaining=1;iterate(iterable,function(promise){var index=counter++,alreadyCalled=!1;values.push(void 0),remaining++,$promiseResolve.call(C,promise).then(function(value){alreadyCalled||(alreadyCalled=!0,values[index]=value,--remaining||resolve(values));},reject);}),--remaining||resolve(values);});return result.error&&reject(result.value),capability.promise},race:function race(iterable){var C=this,capability=newPromiseCapability(C),reject=capability.reject,result=perform(function(){var $promiseResolve=aFunction(C.resolve);iterate(iterable,function(promise){$promiseResolve.call(C,promise).then(capability.resolve,reject);});});return result.error&&reject(result.value),capability.promise}});})();